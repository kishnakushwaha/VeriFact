name: Deploy to EC2

on:
  push:
    branches: [main, master]
  workflow_dispatch:  # Manual trigger

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/fake-news-detector
  CONTAINER_NAME: fake-news-detector

jobs:
  # Run tests first
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install test dependencies
        run: |
          cat requirements.txt
          pip install -r requirements.txt
      
      - name: Run tests
        run: pytest tests/ -v --tb=short

  # Build and push Docker image
  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Deploy to EC2
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # AGGRESSIVE CLEANUP BEFORE DEPLOYMENT
            # Remove all stopped containers
            docker container prune -f
            
            # Remove all unused images (not just dangling)
            docker image prune -a -f
            
            # Remove unused volumes
            docker volume prune -f
            
            # Show disk space before pull
            echo "Disk space before pull:"
            df -h /
            
            # Pull latest image
            docker pull ${{ env.DOCKER_IMAGE }}:latest
            
            # Stop and remove old container if exists
            docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
            docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true
            
            # Run new container with memory-safe settings
            # --memory=3g: Hard limit leaves 1GB for OS/SSH
            # --restart=on-failure:3: Prevents infinite OOM loops
            # -e STANCE_MODEL=deberta: Use smaller model (700MB vs 1.6GB)
            docker run -d \
              --name ${{ env.CONTAINER_NAME }} \
              -p 5000:5000 \
              --memory=3g \
              --memory-swap=3g \
              -e TAVILY_API_KEY=${{ secrets.TAVILY_API_KEY }} \
              -e STANCE_MODEL=bart \
              --restart=on-failure:3 \
              ${{ env.DOCKER_IMAGE }}:latest
            
            # POST-DEPLOYMENT CLEANUP
            # Remove old/dangling images after new container is running
            docker image prune -f
            
            # Show final disk space
            echo "Disk space after deployment:"
            df -h /
            
            # Wait longer for lazy model loading on first health check
            echo "Waiting for container to stabilize (2 minutes)..."
            sleep 120
            
            # Health check
            curl -f http://localhost:5000/api/health || exit 1
